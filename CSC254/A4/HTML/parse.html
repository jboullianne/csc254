<html><a name="1"></a>/* picoc parser - parses source and executes statements */
<br><a name="2"></a>
<br><a name="3"></a>#<font color="red">include </font>"picoc.h"
<br><a name="4"></a>#<font color="red">include </font>"interpreter.h"
<br><a name="5"></a>
<br><a name="6"></a>/* deallocate any memory */
<br><a name="7"></a>void ParseCleanup(<a href="interpreter_header.html#61">Picoc</a> *<a href="parse.html#69">pc</a>)
<br><a name="8"></a>{
<br><a name="9"></a>    <font color="red">while </font>(<a href="parse.html#7">pc</a>->CleanupTokenList != NULL)
<br><a name="10"></a>    {
<br><a name="11"></a>        <font color="blue">struct </font><a href="interpreter_header.html#331">CleanupTokenNode</a> *Next = <a href="parse.html#7">pc</a>->CleanupTokenList->Next;
<br><a name="12"></a>        
<br><a name="13"></a>        <a style="color:green" href="heap.html#226">HeapFreeMem</a>(<a href="parse.html#7">pc</a>, <a href="parse.html#7">pc</a>->CleanupTokenList->Tokens);
<br><a name="14"></a>        <font color="red">if </font>(<a href="parse.html#7">pc</a>->CleanupTokenList->SourceText != NULL)
<br><a name="15"></a>            <a style="color:green" href="heap.html#226">HeapFreeMem</a>(<a href="parse.html#7">pc</a>, (void *)<a href="parse.html#7">pc</a>->CleanupTokenList->SourceText);
<br><a name="16"></a>            
<br><a name="17"></a>        <a style="color:green" href="heap.html#226">HeapFreeMem</a>(<a href="parse.html#7">pc</a>, <a href="parse.html#7">pc</a>->CleanupTokenList);
<br><a name="18"></a>        <a href="parse.html#7">pc</a>->CleanupTokenList = <a href="parse.html#11">Next</a>;
<br><a name="19"></a>    }
<br><a name="20"></a>}
<br><a name="21"></a>
<br><a name="22"></a>/* parse a statement, but only run it <font color="red">if </font><a href="parse.html#447">Condition</a> is TRUE */
<br><a name="23"></a>enum ParseResult <a href="interpreter_header.html#116">ParseState</a>mentMaybeRun(<font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> *<a href="parse.html#938">Parser</a>, <font color="blue">int </font><a href="parse.html#447">Condition</a>, <font color="blue">int </font>CheckTrailingSemicolon)
<br><a name="24"></a>{
<br><a name="25"></a>    <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode != RunModeSkip && !Condition)
<br><a name="26"></a>    {
<br><a name="27"></a>        enum RunMode <a href="parse.html#453">OldMode</a> = <a href="parse.html#23">Parser</a>->Mode;
<br><a name="28"></a>        <font color="blue">int </font>Result;
<br><a name="29"></a>        <a href="parse.html#23">Parser</a>->Mode = RunModeSkip;
<br><a name="30"></a>        <a href="parse.html#28">Result</a> = <a style="color:green" href="parse.html#568">ParseStatement</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#23">CheckTrailingSemicolon</a>);
<br><a name="31"></a>        <a href="parse.html#23">Parser</a>->Mode = <a href="parse.html#27">OldMode</a>;
<br><a name="32"></a>        <font color="red">return </font><a href="parse.html#28">Result</a>;
<br><a name="33"></a>    }
<br><a name="34"></a>    else
<br><a name="35"></a>        <font color="red">return </font><a style="color:green" href="parse.html#568">ParseStatement</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#23">CheckTrailingSemicolon</a>);
<br><a name="36"></a>}
<br><a name="37"></a>
<br><a name="38"></a>/* count the number of parameters to a function or macro */
<br><a name="39"></a><font color="blue">int </font>ParseCountParams(<font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> *<a href="parse.html#23">Parser</a>)
<br><a name="40"></a>{
<br><a name="41"></a>    <font color="blue">int </font><a href="parse.html#68">ParamCount</a> = 0;
<br><a name="42"></a>    
<br><a name="43"></a>    enum Lex<a href="parse.html#63">Token</a> <a href="parse.html#63">Token</a> = LexGet<a href="parse.html#63">Token</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE);
<br><a name="44"></a>    <font color="red">if </font>(<a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>CloseBracket && <a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>EOF)
<br><a name="45"></a>    { 
<br><a name="46"></a>        /* count the number of parameters */
<br><a name="47"></a>        <a href="parse.html#41">ParamCount</a>++;
<br><a name="48"></a>        <font color="red">while </font>((<a href="parse.html#43">Token</a> = LexGet<a href="parse.html#43">Token</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE)) != <a href="parse.html#43">Token</a>CloseBracket && <a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>EOF)
<br><a name="49"></a>        { 
<br><a name="50"></a>            <font color="red">if </font>(<a href="parse.html#43">Token</a> == <a href="parse.html#43">Token</a>Comma)
<br><a name="51"></a>                <a href="parse.html#41">ParamCount</a>++;
<br><a name="52"></a>        } 
<br><a name="53"></a>    }
<br><a name="54"></a>    
<br><a name="55"></a>    <font color="red">return </font><a href="parse.html#41">ParamCount</a>;
<br><a name="56"></a>}
<br><a name="57"></a>
<br><a name="58"></a>/* parse a function definition and store it <font color="red">for </font>later */
<br><a name="59"></a><font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *ParseFunctionDefinition(<font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> *<a href="parse.html#23">Parser</a>, <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a>Type *ReturnType, <font color="blue">char </font>*<a href="parse.html#316">Identifier</a>)
<br><a name="60"></a>{
<br><a name="61"></a>    <font color="blue">struct </font><a href="interpreter_header.html#160">ValueType</a> *ParamType;
<br><a name="62"></a>    <font color="blue">char </font>*ParamIdentifier;
<br><a name="63"></a>    enum Lex<a href="parse.html#43">Token</a> <a href="parse.html#43">Token</a> = <a href="parse.html#43">Token</a>None;
<br><a name="64"></a>    <font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> <a href="parse.html#382">ParamParser</a>;
<br><a name="65"></a>    <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *Func<a href="interpreter_header.html#217">Value</a>;
<br><a name="66"></a>    <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *OldFunc<a href="interpreter_header.html#217">Value</a>;
<br><a name="67"></a>    <font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> FuncBody;
<br><a name="68"></a>    <font color="blue">int </font><a href="parse.html#41">ParamCount</a> = 0;
<br><a name="69"></a>    <a href="interpreter_header.html#61">Picoc</a> *<a href="parse.html#7">pc</a> = <a href="parse.html#23">Parser</a>-><a href="parse.html#7">pc</a>;
<br><a name="70"></a>
<br><a name="71"></a>    <font color="red">if </font>(<a href="parse.html#7">pc</a>->TopStackFrame != NULL)
<br><a name="72"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "nested function definitions are not allowed");
<br><a name="73"></a>        
<br><a name="74"></a>    <a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE);  /* open bracket */
<br><a name="75"></a>    <a style="color:green" href="parse.html#429"><a href="parse.html#23">Parser</a>Copy</a>(&Param<a href="parse.html#23">Parser</a>, <a href="parse.html#23">Parser</a>);
<br><a name="76"></a>    <a href="parse.html#41">ParamCount</a> = <a style="color:green" href="parse.html#39">ParseCountParams</a>(<a href="parse.html#23">Parser</a>);
<br><a name="77"></a>    <font color="red">if </font>(<a href="parse.html#41">ParamCount</a> > PARAMETER_MAX)
<br><a name="78"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "too many parameters (%d allowed)", PARAMETER_MAX);
<br><a name="79"></a>    
<br><a name="80"></a>    <a href="parse.html#65">FuncValue</a> = <a style="color:green" href="variable.html#89">VariableAllocValueAndData</a>(<a href="parse.html#7">pc</a>, <a href="parse.html#23">Parser</a>, sizeof(<font color="blue">struct </font><a href="interpreter_header.html#176">FuncDef</a>) + sizeof(<font color="blue">struct </font><a href="interpreter_header.html#160">ValueType</a> *) * <a href="parse.html#41">ParamCount</a> + sizeof(const <font color="blue">char </font>*) * <a href="parse.html#41">ParamCount</a>, FALSE, NULL, TRUE);
<br><a name="81"></a>    <a href="parse.html#65">FuncValue</a>->Typ = &pc->FunctionType;
<br><a name="82"></a>    <a href="parse.html#65">FuncValue</a>->Val->FuncDef.<a href="parse.html#59">ReturnType</a> = <a href="parse.html#59">ReturnType</a>;
<br><a name="83"></a>    <a href="parse.html#65">FuncValue</a>->Val->FuncDef.NumParams = <a href="parse.html#41">ParamCount</a>;
<br><a name="84"></a>    <a href="parse.html#65">FuncValue</a>->Val->FuncDef.VarArgs = FALSE;
<br><a name="85"></a>    <a href="parse.html#65">FuncValue</a>->Val-><a href="interpreter_header.html#176">FuncDef</a>.ParamType = (<font color="blue">struct </font><a href="interpreter_header.html#160">ValueType</a> **)((<font color="blue">char </font>*)<a href="parse.html#65">FuncValue</a>->Val + sizeof(<font color="blue">struct </font><a href="interpreter_header.html#176">FuncDef</a>));
<br><a name="86"></a>    <a href="parse.html#65">FuncValue</a>->Val->FuncDef.ParamName = (<font color="blue">char </font>**)((<font color="blue">char </font>*)<a href="parse.html#65">FuncValue</a>->Val->FuncDef.ParamType + sizeof(<font color="blue">struct </font><a href="interpreter_header.html#160">ValueType</a> *) * <a href="parse.html#41">ParamCount</a>);
<br><a name="87"></a>   
<br><a name="88"></a>    <font color="red">for </font>(<a href="parse.html#41">ParamCount</a> = 0; <a href="parse.html#41">ParamCount</a> &lt; <a href="parse.html#65">FuncValue</a>-&gt;Val-&gt;FuncDef.NumParams; <a href="parse.html#41">ParamCount</a>++)
<br><a name="89"></a>    { 
<br><a name="90"></a>        /* harvest the parameters into the function definition */
<br><a name="91"></a>        <font color="red">if </font>(<a href="parse.html#41">ParamCount</a> == <a href="parse.html#65">FuncValue</a>->Val->FuncDef.NumParams-1 && <a style="color:green" href="lex.html#883">LexGetToken</a>(&ParamParser, NULL, FALSE) == TokenEllipsis)
<br><a name="92"></a>        { 
<br><a name="93"></a>            /* ellipsis at end */
<br><a name="94"></a>            <a href="parse.html#65">FuncValue</a>->Val->FuncDef.NumParams--;
<br><a name="95"></a>            <a href="parse.html#65">FuncValue</a>->Val->FuncDef.VarArgs = TRUE;
<br><a name="96"></a>            break;
<br><a name="97"></a>        }
<br><a name="98"></a>        else
<br><a name="99"></a>        { 
<br><a name="100"></a>            /* add a parameter */
<br><a name="101"></a>            <a style="color:green" href="type.html#526">TypeParse</a>(&ParamParser, &ParamType, &ParamIdentifier, NULL);
<br><a name="102"></a>            <font color="red">if </font>(<a href="parse.html#61">ParamType</a>->Base == TypeVoid)
<br><a name="103"></a>            {
<br><a name="104"></a>                /* this isn't a real parameter at all - delete it */
<br><a name="105"></a>                <a href="parse.html#41">ParamCount</a>--;
<br><a name="106"></a>                <a href="parse.html#65">FuncValue</a>->Val->FuncDef.NumParams--;
<br><a name="107"></a>            }
<br><a name="108"></a>            else
<br><a name="109"></a>            {
<br><a name="110"></a>                <a href="parse.html#65">FuncValue</a>->Val->FuncDef.<a href="parse.html#61">ParamType</a><font color="red">[</font>ParamCount<font color="red">]</font> = <a href="parse.html#61">ParamType</a>;
<br><a name="111"></a>                <a href="parse.html#65">FuncValue</a>->Val->FuncDef.ParamName<font color="red">[</font>ParamCount<font color="red">]</font> = <a href="parse.html#62">ParamIdentifier</a>;
<br><a name="112"></a>            }
<br><a name="113"></a>        }
<br><a name="114"></a>        
<br><a name="115"></a>        <a href="parse.html#43">Token</a> = LexGet<a href="parse.html#43">Token</a>(&ParamParser, NULL, TRUE);
<br><a name="116"></a>        <font color="red">if </font>(<a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>Comma && <a href="parse.html#41">ParamCount</a> &lt; <a href="parse.html#65">FuncValue</a>-&gt;Val-&gt;FuncDef.NumParams-1)
<br><a name="117"></a>            <a style="color:green" href="platform.html#134">ProgramFail</a>(&ParamParser, "comma expected");
<br><a name="118"></a>    }
<br><a name="119"></a>    
<br><a name="120"></a>    <font color="red">if </font>(<a href="parse.html#65">FuncValue</a>->Val->FuncDef.NumParams != 0 && <a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>CloseBracket && <a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>Comma && <a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>Ellipsis)
<br><a name="121"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(&ParamParser, "bad parameter");
<br><a name="122"></a>    
<br><a name="123"></a>    <font color="red">if </font>(strcmp(<a href="parse.html#59">Identifier</a>, "main") == 0)
<br><a name="124"></a>    {
<br><a name="125"></a>        /* make sure it's <font color="blue">int </font><a style="color:green" href="picoc.html#16">main</a>() */
<br><a name="126"></a>        <font color="red">if </font>( <a href="parse.html#65">FuncValue</a>->Val->FuncDef.ReturnType != &pc->IntType &&
<br><a name="127"></a>             <a href="parse.html#65">FuncValue</a>->Val->FuncDef.ReturnType != &pc->VoidType )
<br><a name="128"></a>            <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "main() should <font color="red">return </font>an <font color="blue">int </font>or void");
<br><a name="129"></a>
<br><a name="130"></a>        <font color="red">if </font>(<a href="parse.html#65">FuncValue</a>->Val->FuncDef.NumParams != 0 &&
<br><a name="131"></a>             (<a href="parse.html#65">FuncValue</a>->Val->FuncDef.NumParams != 2 || <a href="parse.html#65">FuncValue</a>->Val->FuncDef.ParamType<font color="red">[</font>0<font color="red">]</font> != &pc->IntType) )
<br><a name="132"></a>            <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "bad parameters to <a style="color:green" href="picoc.html#16">main</a>()");
<br><a name="133"></a>    }
<br><a name="134"></a>    
<br><a name="135"></a>    /* look <font color="red">for </font>a function body */
<br><a name="136"></a>    <a href="parse.html#43">Token</a> = LexGet<a href="parse.html#43">Token</a>(<a href="parse.html#23">Parser</a>, NULL, FALSE);
<br><a name="137"></a>    <font color="red">if </font>(<a href="parse.html#43">Token</a> == <a href="parse.html#43">Token</a>Semicolon)
<br><a name="138"></a>        <a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE);    /* it's a prototype, absorb the trailing semicolon */
<br><a name="139"></a>    else
<br><a name="140"></a>    {
<br><a name="141"></a>        /* it's a full function definition with a body */
<br><a name="142"></a>        <font color="red">if </font>(<a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>LeftBrace)
<br><a name="143"></a>            <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "bad function definition");
<br><a name="144"></a>        
<br><a name="145"></a>        <a style="color:green" href="parse.html#429"><a href="parse.html#23">Parser</a>Copy</a>(&FuncBody, <a href="parse.html#23">Parser</a>);
<br><a name="146"></a>        <font color="red">if </font>(<a style="color:green" href="parse.html#23">ParseStatementMaybeRun</a>(<a href="parse.html#23">Parser</a>, FALSE, TRUE) != ParseResultOk)
<br><a name="147"></a>            <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "function definition expected");
<br><a name="148"></a>
<br><a name="149"></a>        <a href="parse.html#65">FuncValue</a>->Val->FuncDef.Body = <a href="parse.html#67">FuncBody</a>;
<br><a name="150"></a>        <a href="parse.html#65">FuncValue</a>->Val->FuncDef.Body.Pos = <a style="color:green" href="lex.html#934">LexCopyTokens</a>(&FuncBody, <a href="parse.html#23">Parser</a>);
<br><a name="151"></a>
<br><a name="152"></a>        /* is this function already in the global table? */
<br><a name="153"></a>        <font color="red">if </font>(<a style="color:green" href="table.html#81">TableGet</a>(&pc->GlobalTable, <a href="parse.html#59">Identifier</a>, &OldFuncValue, NULL, NULL, NULL))
<br><a name="154"></a>        {
<br><a name="155"></a>            <font color="red">if </font>(<a href="parse.html#66">OldFuncValue</a>->Val->FuncDef.Body.Pos == NULL)
<br><a name="156"></a>            {
<br><a name="157"></a>                /* override an old function prototype */
<br><a name="158"></a>                <a style="color:green" href="variable.html#19">VariableFree</a>(<a href="parse.html#7">pc</a>, <a style="color:green" href="table.html#101">TableDelete</a>(<a href="parse.html#7">pc</a>, &<a href="parse.html#7">pc</a>->GlobalTable, <a href="parse.html#59">Identifier</a>));
<br><a name="159"></a>            }
<br><a name="160"></a>            else
<br><a name="161"></a>                <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "'%s' is already defined", <a href="parse.html#59">Identifier</a>);
<br><a name="162"></a>        }
<br><a name="163"></a>    }
<br><a name="164"></a>
<br><a name="165"></a>    <font color="red">if </font>(!TableSet(<a href="parse.html#7">pc</a>, &<a href="parse.html#7">pc</a>->GlobalTable, <a href="parse.html#59">Identifier</a>, <a href="parse.html#65">FuncValue</a>, (<font color="blue">char </font>*)<a href="parse.html#23">Parser</a>->FileName, <a href="parse.html#23">Parser</a>->Line, <a href="parse.html#23">Parser</a>->CharacterPos))
<br><a name="166"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "'%s' is already defined", <a href="parse.html#59">Identifier</a>);
<br><a name="167"></a>        
<br><a name="168"></a>    <font color="red">return </font><a href="parse.html#65">FuncValue</a>;
<br><a name="169"></a>}
<br><a name="170"></a>
<br><a name="171"></a>/* parse an array initialiser and assign to a variable */
<br><a name="172"></a><font color="blue">int </font>ParseArrayInitialiser(<font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> *<a href="parse.html#23">Parser</a>, <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *<a href="parse.html#319">NewVariable</a>, <font color="blue">int </font>DoAssignment)
<br><a name="173"></a>{
<br><a name="174"></a>    <font color="blue">int </font>ArrayIndex = 0;
<br><a name="175"></a>    enum Lex<a href="parse.html#43">Token</a> <a href="parse.html#43">Token</a>;
<br><a name="176"></a>    <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *C<a href="interpreter_header.html#217">Value</a>;
<br><a name="177"></a>    
<br><a name="178"></a>    /* count the number of elements in the array */
<br><a name="179"></a>    <font color="red">if </font>(<a href="parse.html#172">DoAssignment</a> && <a href="parse.html#23">Parser</a>->Mode == RunModeRun)
<br><a name="180"></a>    {
<br><a name="181"></a>        <font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> CountParser;
<br><a name="182"></a>        <font color="blue">int </font>NumElements;
<br><a name="183"></a>        
<br><a name="184"></a>        <a style="color:green" href="parse.html#429"><a href="parse.html#23">Parser</a>Copy</a>(&Count<a href="parse.html#23">Parser</a>, <a href="parse.html#23">Parser</a>);
<br><a name="185"></a>        <a href="parse.html#182">NumElements</a> = <a style="color:green" href="parse.html#172">ParseArrayInitialiser</a>(&CountParser, <a href="parse.html#172">NewVariable</a>, FALSE);
<br><a name="186"></a>
<br><a name="187"></a>        <font color="red">if </font>(<a href="parse.html#172">NewVariable</a>->Typ->Base != TypeArray)
<br><a name="188"></a>            <a style="color:green" href="platform.html#159">AssignFail</a>(<a href="parse.html#23">Parser</a>, "%t from array initializer", <a href="parse.html#172">NewVariable</a>->Typ, NULL, 0, 0, NULL, 0);
<br><a name="189"></a>
<br><a name="190"></a>        <font color="red">if </font>(<a href="parse.html#172">NewVariable</a>->Typ->ArraySize == 0)
<br><a name="191"></a>        {
<br><a name="192"></a>            <a href="parse.html#172">NewVariable</a>->Typ = <a style="color:green" href="type.html#32">TypeGetMatching</a>(<a href="parse.html#23">Parser</a>->pc, <a href="parse.html#23">Parser</a>, <a href="parse.html#172">NewVariable</a>->Typ->FromType, <a href="parse.html#172">NewVariable</a>->Typ->Base, <a href="parse.html#182">NumElements</a>, <a href="parse.html#172">NewVariable</a>->Typ->Identifier, TRUE);
<br><a name="193"></a>            <a style="color:green" href="variable.html#156">VariableRealloc</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#172">NewVariable</a>, <a style="color:green" href="type.html#69">TypeSizeValue</a>(<a href="parse.html#172">NewVariable</a>, FALSE));
<br><a name="194"></a>        }
<br><a name="195"></a>        #ifdef DEBUG_ARRAY_INITIALIZER
<br><a name="196"></a>        PRINT_SOURCE_POS;
<br><a name="197"></a>        printf("array size: %d \n", <a href="parse.html#172">NewVariable</a>->Typ->ArraySize);
<br><a name="198"></a>        #endif
<br><a name="199"></a>    }
<br><a name="200"></a>    
<br><a name="201"></a>    /* parse the array initialiser */
<br><a name="202"></a>    <a href="parse.html#43">Token</a> = LexGet<a href="parse.html#43">Token</a>(<a href="parse.html#23">Parser</a>, NULL, FALSE);
<br><a name="203"></a>    <font color="red">while </font>(<a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>RightBrace)
<br><a name="204"></a>    {
<br><a name="205"></a>        <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, FALSE) == TokenLeftBrace)
<br><a name="206"></a>        {
<br><a name="207"></a>            /* this is a sub-array initialiser */
<br><a name="208"></a>            <font color="blue">int </font>SubArraySize = 0;
<br><a name="209"></a>            <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *SubArray = <a href="parse.html#172">NewVariable</a>; 
<br><a name="210"></a>            <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeRun && <a href="parse.html#172">DoAssignment</a>)
<br><a name="211"></a>            {
<br><a name="212"></a>                <a href="parse.html#208">SubArraySize</a> = <a style="color:green" href="type.html#80">TypeSize</a>(<a href="parse.html#172">NewVariable</a>->Typ->FromType, <a href="parse.html#172">NewVariable</a>->Typ->FromType->ArraySize, TRUE);
<br><a name="213"></a>                <a href="parse.html#209">SubArray</a> = <a style="color:green" href="variable.html#135">VariableAllocValueFromExistingData</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#172">NewVariable</a>->Typ->FromType, (union <a href="interpreter_header.html#196">AnyValue</a> *)(&<a href="parse.html#172">NewVariable</a>->Val->ArrayMem<font color="red">[</font>0<font color="red">]</font> + <a href="parse.html#209">SubArray</a>Size * <a href="parse.html#174">ArrayIndex</a>), TRUE, <a href="parse.html#172">NewVariable</a>);
<br><a name="214"></a>                #ifdef DEBUG_ARRAY_INITIALIZER
<br><a name="215"></a>                <font color="blue">int </font>FullArraySize = <a style="color:green" href="type.html#80">TypeSize</a>(<a href="parse.html#172">NewVariable</a>->Typ, <a href="parse.html#172">NewVariable</a>->Typ->ArraySize, TRUE);
<br><a name="216"></a>                PRINT_SOURCE_POS;
<br><a name="217"></a>                PRINT_TYPE(<a href="parse.html#172">NewVariable</a>->Typ)
<br><a name="218"></a>                printf("<font color="red">[</font>%d<font color="red">]</font> subarray size: %d (full: %d,%d) \n", <a href="parse.html#174">ArrayIndex</a>, <a href="parse.html#208">SubArraySize</a>, FullArraySize, <a href="parse.html#172">NewVariable</a>->Typ->ArraySize);
<br><a name="219"></a>                #endif
<br><a name="220"></a>                <font color="red">if </font>(<a href="parse.html#174">ArrayIndex</a> >= <a href="parse.html#172">NewVariable</a>->Typ->ArraySize)
<br><a name="221"></a>                    <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "too many array elements");
<br><a name="222"></a>            }
<br><a name="223"></a>            <a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE);
<br><a name="224"></a>            <a style="color:green" href="parse.html#172">ParseArrayInitialiser</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#209">SubArray</a>, <a href="parse.html#172">DoAssignment</a>);
<br><a name="225"></a>        }
<br><a name="226"></a>        else
<br><a name="227"></a>        {
<br><a name="228"></a>            <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *ArrayElement = NULL;
<br><a name="229"></a>        
<br><a name="230"></a>            <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeRun && <a href="parse.html#172">DoAssignment</a>)
<br><a name="231"></a>            {
<br><a name="232"></a>                <font color="blue">struct </font><a href="interpreter_header.html#160">ValueType</a> * ElementType = <a href="parse.html#172">NewVariable</a>->Typ;
<br><a name="233"></a>                <font color="blue">int </font>TotalSize = 1;
<br><a name="234"></a>                <font color="blue">int </font>ElementSize = 0;
<br><a name="235"></a>                
<br><a name="236"></a>                /* <font color="blue">int </font>x<font color="red">[</font>3<font color="red">]</font><font color="red">[</font>3<font color="red">]</font> = {1,2,3,4} => handle it just like <font color="blue">int </font>x<font color="red">[</font>9<font color="red">]</font> = {1,2,3,4} */
<br><a name="237"></a>                <font color="red">while </font>(<a href="parse.html#232">ElementType</a>->Base == TypeArray)
<br><a name="238"></a>                {
<br><a name="239"></a>                    <a href="parse.html#233">TotalSize</a> *= <a href="parse.html#232">ElementType</a>->ArraySize;
<br><a name="240"></a>                    <a href="parse.html#232">ElementType</a> = <a href="parse.html#232">ElementType</a>->FromType;
<br><a name="241"></a>                    
<br><a name="242"></a>                    /* <font color="blue">char </font>x<font color="red">[</font>10<font color="red">]</font><font color="red">[</font>10<font color="red">]</font> = {"abc", "def"} => assign "abc" to x<font color="red">[</font>0<font color="red">]</font>, "def" to x<font color="red">[</font>1<font color="red">]</font> etc */
<br><a name="243"></a>                    <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, FALSE) == TokenStringConstant && <a href="parse.html#232">ElementType</a>->FromType->Base == TypeChar)
<br><a name="244"></a>                        break;
<br><a name="245"></a>                }
<br><a name="246"></a>                <a href="parse.html#234">ElementSize</a> = <a style="color:green" href="type.html#80">TypeSize</a>(<a href="parse.html#232">ElementType</a>, <a href="parse.html#232">ElementType</a>->ArraySize, TRUE);
<br><a name="247"></a>                #ifdef DEBUG_ARRAY_INITIALIZER
<br><a name="248"></a>                PRINT_SOURCE_POS;
<br><a name="249"></a>                printf("<font color="red">[</font>%d/%d<font color="red">]</font> element size: %d (x%d) \n", <a href="parse.html#174">ArrayIndex</a>, <a href="parse.html#233">TotalSize</a>, <a href="parse.html#234">ElementSize</a>, <a href="parse.html#232">ElementType</a>->ArraySize);
<br><a name="250"></a>                #endif
<br><a name="251"></a>                <font color="red">if </font>(<a href="parse.html#174">ArrayIndex</a> >= <a href="parse.html#233">TotalSize</a>)
<br><a name="252"></a>                    <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "too many array elements");
<br><a name="253"></a>                <a href="parse.html#228">ArrayElement</a> = <a style="color:green" href="variable.html#135">VariableAllocValueFromExistingData</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#232">ElementType</a>, (union <a href="interpreter_header.html#196">AnyValue</a> *)(&<a href="parse.html#172">NewVariable</a>->Val->ArrayMem<font color="red">[</font>0<font color="red">]</font> + <a href="parse.html#234">ElementSize</a> * <a href="parse.html#174">ArrayIndex</a>), TRUE, <a href="parse.html#172">NewVariable</a>);
<br><a name="254"></a>            }
<br><a name="255"></a>
<br><a name="256"></a>            /* this is a normal expression initialiser */
<br><a name="257"></a>            <font color="red">if </font>(!ExpressionParse(<a href="parse.html#23">Parser</a>, &CValue))
<br><a name="258"></a>                <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "expression expected");
<br><a name="259"></a>
<br><a name="260"></a>            <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeRun && <a href="parse.html#172">DoAssignment</a>)
<br><a name="261"></a>            {
<br><a name="262"></a>                <a style="color:green" href="expression.html#391">ExpressionAssign</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#228">ArrayElement</a>, <a href="parse.html#176">CValue</a>, FALSE, NULL, 0, FALSE);
<br><a name="263"></a>                <a style="color:green" href="variable.html#386">VariableStackPop</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#176">CValue</a>);
<br><a name="264"></a>                <a style="color:green" href="variable.html#386">VariableStackPop</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#228">ArrayElement</a>);
<br><a name="265"></a>            }
<br><a name="266"></a>        }
<br><a name="267"></a>        
<br><a name="268"></a>        <a href="parse.html#174">ArrayIndex</a>++;
<br><a name="269"></a>
<br><a name="270"></a>        <a href="parse.html#43">Token</a> = LexGet<a href="parse.html#43">Token</a>(<a href="parse.html#23">Parser</a>, NULL, FALSE);
<br><a name="271"></a>        <font color="red">if </font>(<a href="parse.html#43">Token</a> == <a href="parse.html#43">Token</a>Comma)
<br><a name="272"></a>        {
<br><a name="273"></a>            <a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE);
<br><a name="274"></a>            <a href="parse.html#43">Token</a> = LexGet<a href="parse.html#43">Token</a>(<a href="parse.html#23">Parser</a>, NULL, FALSE);
<br><a name="275"></a>        }   
<br><a name="276"></a>        else <font color="red">if </font>(<a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>RightBrace)
<br><a name="277"></a>            <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "comma expected");
<br><a name="278"></a>    }
<br><a name="279"></a>    
<br><a name="280"></a>    <font color="red">if </font>(<a href="parse.html#43">Token</a> == <a href="parse.html#43">Token</a>RightBrace)
<br><a name="281"></a>        <a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE);
<br><a name="282"></a>    else
<br><a name="283"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "'}' expected");
<br><a name="284"></a>    
<br><a name="285"></a>    <font color="red">return </font><a href="parse.html#174">ArrayIndex</a>;
<br><a name="286"></a>}
<br><a name="287"></a>
<br><a name="288"></a>/* assign an initial value to a variable */
<br><a name="289"></a>void ParseDeclarationAssignment(<font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> *<a href="parse.html#23">Parser</a>, <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *<a href="parse.html#172">NewVariable</a>, <font color="blue">int </font><a href="parse.html#172">DoAssignment</a>)
<br><a name="290"></a>{
<br><a name="291"></a>    <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *C<a href="interpreter_header.html#217">Value</a>;
<br><a name="292"></a>
<br><a name="293"></a>    <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, FALSE) == TokenLeftBrace)
<br><a name="294"></a>    {
<br><a name="295"></a>        /* this is an array initialiser */
<br><a name="296"></a>        <a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE);
<br><a name="297"></a>        <a style="color:green" href="parse.html#172">ParseArrayInitialiser</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#172">NewVariable</a>, <a href="parse.html#172">DoAssignment</a>);
<br><a name="298"></a>    }
<br><a name="299"></a>    else
<br><a name="300"></a>    {
<br><a name="301"></a>        /* this is a normal expression initialiser */
<br><a name="302"></a>        <font color="red">if </font>(!ExpressionParse(<a href="parse.html#23">Parser</a>, &CValue))
<br><a name="303"></a>            <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "expression expected");
<br><a name="304"></a>            
<br><a name="305"></a>        <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeRun && <a href="parse.html#172">DoAssignment</a>)
<br><a name="306"></a>        {
<br><a name="307"></a>            <a style="color:green" href="expression.html#391">ExpressionAssign</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#172">NewVariable</a>, <a href="parse.html#176">CValue</a>, FALSE, NULL, 0, FALSE);
<br><a name="308"></a>            <a style="color:green" href="variable.html#386">VariableStackPop</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#176">CValue</a>);
<br><a name="309"></a>        }
<br><a name="310"></a>    }
<br><a name="311"></a>}
<br><a name="312"></a>
<br><a name="313"></a>/* declare a variable or function */
<br><a name="314"></a><font color="blue">int </font>ParseDeclaration(<font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> *<a href="parse.html#23">Parser</a>, enum Lex<a href="parse.html#43">Token</a> <a href="parse.html#43">Token</a>)
<br><a name="315"></a>{
<br><a name="316"></a>    <font color="blue">char </font>*<a href="parse.html#59">Identifier</a>;
<br><a name="317"></a>    <font color="blue">struct </font><a href="interpreter_header.html#160">ValueType</a> *BasicType;
<br><a name="318"></a>    <font color="blue">struct </font><a href="interpreter_header.html#160">Value<a href="parse.html#551">Typ</a>e</a> *<a href="parse.html#551">Typ</a>;
<br><a name="319"></a>    <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *<a href="parse.html#172">NewVariable</a> = NULL;
<br><a name="320"></a>    <font color="blue">int </font>IsStatic = FALSE;
<br><a name="321"></a>    <font color="blue">int </font>FirstVisit = FALSE;
<br><a name="322"></a>    <a href="interpreter_header.html#61">Picoc</a> *<a href="parse.html#7">pc</a> = <a href="parse.html#23">Parser</a>-><a href="parse.html#7">pc</a>;
<br><a name="323"></a>
<br><a name="324"></a>    <a style="color:green" href="type.html#350">TypeParseFront</a>(<a href="parse.html#23">Parser</a>, &BasicType, &IsStatic);
<br><a name="325"></a>    do
<br><a name="326"></a>    {
<br><a name="327"></a>        <a style="color:green" href="type.html#472">TypeParseIdentPart</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#317">BasicType</a>, &Typ, &Identifier);
<br><a name="328"></a>        <font color="red">if </font>((<a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>VoidType && <a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>StructType && <a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>UnionType && <a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>EnumType) && <a href="parse.html#59">Identifier</a> == <a href="parse.html#7">pc</a>->StrEmpty)
<br><a name="329"></a>            <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "identifier expected");
<br><a name="330"></a>            
<br><a name="331"></a>        <font color="red">if </font>(<a href="parse.html#59">Identifier</a> != <a href="parse.html#7">pc</a>->StrEmpty)
<br><a name="332"></a>        {
<br><a name="333"></a>            /* handle function definitions */
<br><a name="334"></a>            <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, FALSE) == TokenOpenBracket)
<br><a name="335"></a>            {
<br><a name="336"></a>                <a style="color:green" href="parse.html#59">ParseFunctionDefinition</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#318">Typ</a>, <a href="parse.html#59">Identifier</a>);
<br><a name="337"></a>                <font color="red">return </font>FALSE;
<br><a name="338"></a>            }
<br><a name="339"></a>            else
<br><a name="340"></a>            {
<br><a name="341"></a>                <font color="red">if </font>(<a href="parse.html#318">Typ</a> == &<a href="parse.html#7">pc</a>->Void<a href="parse.html#318">Typ</a>e && <a href="parse.html#59">Identifier</a> != <a href="parse.html#7">pc</a>->StrEmpty)
<br><a name="342"></a>                    <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "can't define a void variable");
<br><a name="343"></a>                    
<br><a name="344"></a>                <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeRun || <a href="parse.html#23">Parser</a>->Mode == RunModeGoto)
<br><a name="345"></a>                    <a href="parse.html#172">NewVariable</a> = <a style="color:green" href="variable.html#285">VariableDefineButIgnoreIdentical</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#59">Identifier</a>, <a href="parse.html#318">Typ</a>, <a href="parse.html#320">IsStatic</a>, &FirstVisit);
<br><a name="346"></a>                
<br><a name="347"></a>                <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, FALSE) == TokenAssign)
<br><a name="348"></a>                {
<br><a name="349"></a>                    /* we're assigning an initial value */
<br><a name="350"></a>                    <a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE);
<br><a name="351"></a>                    <a style="color:green" href="parse.html#289">ParseDeclarationAssignment</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#172">NewVariable</a>, !IsStatic || <a href="parse.html#321">FirstVisit</a>);
<br><a name="352"></a>                }
<br><a name="353"></a>            }
<br><a name="354"></a>        }
<br><a name="355"></a>        
<br><a name="356"></a>        <a href="parse.html#43">Token</a> = LexGet<a href="parse.html#43">Token</a>(<a href="parse.html#23">Parser</a>, NULL, FALSE);
<br><a name="357"></a>        <font color="red">if </font>(<a href="parse.html#43">Token</a> == <a href="parse.html#43">Token</a>Comma)
<br><a name="358"></a>            <a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE);
<br><a name="359"></a>            
<br><a name="360"></a>    } <font color="red">while </font>(<a href="parse.html#43">Token</a> == <a href="parse.html#43">Token</a>Comma);
<br><a name="361"></a>    
<br><a name="362"></a>    <font color="red">return </font>TRUE;
<br><a name="363"></a>}
<br><a name="364"></a>
<br><a name="365"></a>/* parse a #define macro definition and store it <font color="red">for </font>later */
<br><a name="366"></a>void ParseMacroDefinition(<font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> *<a href="parse.html#23">Parser</a>)
<br><a name="367"></a>{
<br><a name="368"></a>    <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *MacroName;
<br><a name="369"></a>    <font color="blue">char </font>*MacroNameStr;
<br><a name="370"></a>    <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *ParamName;
<br><a name="371"></a>    <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *Macro<a href="interpreter_header.html#217">Value</a>;
<br><a name="372"></a>
<br><a name="373"></a>    <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, &MacroName, TRUE) != TokenIdentifier)
<br><a name="374"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "identifier expected");
<br><a name="375"></a>    
<br><a name="376"></a>    <a href="parse.html#369"><a href="parse.html#368">MacroName</a>Str</a> = <a href="parse.html#368">MacroName</a>->Val->Identifier;
<br><a name="377"></a>    
<br><a name="378"></a>    <font color="red">if </font>(<a style="color:green" href="lex.html#915">LexRawPeekToken</a>(<a href="parse.html#23">Parser</a>) == TokenOpenMacroBracket)
<br><a name="379"></a>    {
<br><a name="380"></a>        /* it's a parameterised macro, read the parameters */
<br><a name="381"></a>        enum Lex<a href="parse.html#43">Token</a> <a href="parse.html#43">Token</a> = LexGet<a href="parse.html#43">Token</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE);
<br><a name="382"></a>        <font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> <a href="parse.html#64">ParamParser</a>;
<br><a name="383"></a>        <font color="blue">int </font>NumParams;
<br><a name="384"></a>        <font color="blue">int </font><a href="parse.html#41">ParamCount</a> = 0;
<br><a name="385"></a>        
<br><a name="386"></a>        <a style="color:green" href="parse.html#429"><a href="parse.html#23">Parser</a>Copy</a>(&Param<a href="parse.html#23">Parser</a>, <a href="parse.html#23">Parser</a>);
<br><a name="387"></a>        <a href="parse.html#383">NumParams</a> = <a style="color:green" href="parse.html#39">ParseCountParams</a>(&ParamParser);
<br><a name="388"></a>        <a href="parse.html#371">MacroValue</a> = <a style="color:green" href="variable.html#89">VariableAllocValueAndData</a>(<a href="parse.html#23">Parser</a>->pc, <a href="parse.html#23">Parser</a>, sizeof(<font color="blue">struct </font><a href="interpreter_header.html#188">MacroDef</a>) + sizeof(const <font color="blue">char </font>*) * <a href="parse.html#383">NumParams</a>, FALSE, NULL, TRUE);
<br><a name="389"></a>        <a href="parse.html#371">MacroValue</a>->Val->MacroDef.<a href="parse.html#383">NumParams</a> = <a href="parse.html#383">NumParams</a>;
<br><a name="390"></a>        <a href="parse.html#371">MacroValue</a>->Val-><a href="interpreter_header.html#188">MacroDef</a>.ParamName = (<font color="blue">char </font>**)((<font color="blue">char </font>*)<a href="parse.html#371">MacroValue</a>->Val + sizeof(<font color="blue">struct </font><a href="interpreter_header.html#188">MacroDef</a>));
<br><a name="391"></a>
<br><a name="392"></a>        <a href="parse.html#43">Token</a> = LexGet<a href="parse.html#43">Token</a>(<a href="parse.html#23">Parser</a>, &ParamName, TRUE);
<br><a name="393"></a>        
<br><a name="394"></a>        <font color="red">while </font>(<a href="parse.html#43">Token</a> == <a href="parse.html#43">Token</a>Identifier)
<br><a name="395"></a>        {
<br><a name="396"></a>            /* store a parameter name */
<br><a name="397"></a>            <a href="parse.html#371">MacroValue</a>->Val->MacroDef.<a href="parse.html#370">ParamName</a><font color="red">[</font>ParamCount++<font color="red">]</font> = <a href="parse.html#370">ParamName</a>->Val->Identifier;
<br><a name="398"></a>            
<br><a name="399"></a>            /* get the trailing comma */
<br><a name="400"></a>            <a href="parse.html#43">Token</a> = LexGet<a href="parse.html#43">Token</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE);
<br><a name="401"></a>            <font color="red">if </font>(<a href="parse.html#43">Token</a> == <a href="parse.html#43">Token</a>Comma)
<br><a name="402"></a>                <a href="parse.html#43">Token</a> = LexGet<a href="parse.html#43">Token</a>(<a href="parse.html#23">Parser</a>, &ParamName, TRUE);
<br><a name="403"></a>                
<br><a name="404"></a>            else <font color="red">if </font>(<a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>CloseBracket)
<br><a name="405"></a>                <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "comma expected");
<br><a name="406"></a>        }
<br><a name="407"></a>        
<br><a name="408"></a>        <font color="red">if </font>(<a href="parse.html#43">Token</a> != <a href="parse.html#43">Token</a>CloseBracket)
<br><a name="409"></a>            <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "close bracket expected");
<br><a name="410"></a>    }
<br><a name="411"></a>    else
<br><a name="412"></a>    {
<br><a name="413"></a>        /* allocate a simple unparameterised macro */
<br><a name="414"></a>        <a href="parse.html#371">MacroValue</a> = <a style="color:green" href="variable.html#89">VariableAllocValueAndData</a>(<a href="parse.html#23">Parser</a>->pc, <a href="parse.html#23">Parser</a>, sizeof(<font color="blue">struct </font><a href="interpreter_header.html#188">MacroDef</a>), FALSE, NULL, TRUE);
<br><a name="415"></a>        <a href="parse.html#371">MacroValue</a>->Val->MacroDef.NumParams = 0;
<br><a name="416"></a>    }
<br><a name="417"></a>    
<br><a name="418"></a>    /* copy the body of the macro to execute later */
<br><a name="419"></a>    <a style="color:green" href="parse.html#429"><a href="parse.html#23">Parser</a>Copy</a>(&MacroValue->Val->MacroDef.Body, <a href="parse.html#23">Parser</a>);
<br><a name="420"></a>    <a href="parse.html#371">MacroValue</a>->Typ = &Parser->pc->MacroType;
<br><a name="421"></a>    <a style="color:green" href="lex.html#921">LexToEndOfLine</a>(<a href="parse.html#23">Parser</a>);
<br><a name="422"></a>    <a href="parse.html#371">MacroValue</a>->Val->MacroDef.Body.Pos = <a style="color:green" href="lex.html#934">LexCopyTokens</a>(&<a href="parse.html#371">MacroValue</a>->Val->MacroDef.Body, <a href="parse.html#23">Parser</a>);
<br><a name="423"></a>    
<br><a name="424"></a>    <font color="red">if </font>(!TableSet(<a href="parse.html#23">Parser</a>->pc, &<a href="parse.html#23">Parser</a>->pc->GlobalTable, <a href="parse.html#369">MacroNameStr</a>, <a href="parse.html#371">MacroValue</a>, (<font color="blue">char </font>*)<a href="parse.html#23">Parser</a>->FileName, <a href="parse.html#23">Parser</a>->Line, <a href="parse.html#23">Parser</a>->CharacterPos))
<br><a name="425"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "'%s' is already defined", <a href="parse.html#369">MacroNameStr</a>);
<br><a name="426"></a>}
<br><a name="427"></a>
<br><a name="428"></a>/* copy the entire parser state */
<br><a name="429"></a>void ParserCopy(<font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> *To, <font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> *From)
<br><a name="430"></a>{
<br><a name="431"></a>    memcpy((void *)<a href="parse.html#429">To</a>, (void *)<a href="parse.html#429">From</a>, sizeof(*<a href="parse.html#429">To</a>));
<br><a name="432"></a>}
<br><a name="433"></a>
<br><a name="434"></a>/* copy where we're at in the parsing */
<br><a name="435"></a>void ParserCopyPos(<font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> *<a href="parse.html#429">To</a>, <font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> *<a href="parse.html#429">From</a>)
<br><a name="436"></a>{
<br><a name="437"></a>    <a href="parse.html#429">To</a>->Pos = <a href="parse.html#429">From</a>->Pos;
<br><a name="438"></a>    <a href="parse.html#429">To</a>->Line = <a href="parse.html#429">From</a>->Line;
<br><a name="439"></a>    <a href="parse.html#429">To</a>->HashIfLevel = <a href="parse.html#429">From</a>->HashIfLevel;
<br><a name="440"></a>    <a href="parse.html#429">To</a>->HashIfEvaluate<a href="parse.html#429">To</a>Level = <a href="parse.html#429">From</a>->HashIfEvaluate<a href="parse.html#429">To</a>Level;
<br><a name="441"></a>    <a href="parse.html#429">To</a>->CharacterPos = <a href="parse.html#429">From</a>->CharacterPos;
<br><a name="442"></a>}
<br><a name="443"></a>
<br><a name="444"></a>/* parse a "for" statement */
<br><a name="445"></a>void ParseFor(<font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> *<a href="parse.html#23">Parser</a>)
<br><a name="446"></a>{
<br><a name="447"></a>    <font color="blue">int </font><a href="parse.html#23">Condition</a>;
<br><a name="448"></a>    <font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> <a href="parse.html#686">PreConditional</a>;
<br><a name="449"></a>    <font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> PreIncrement;
<br><a name="450"></a>    <font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> <a href="parse.html#717">PreStatement</a>;
<br><a name="451"></a>    <font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> After;
<br><a name="452"></a>    
<br><a name="453"></a>    enum RunMode <a href="parse.html#27">OldMode</a> = <a href="parse.html#23">Parser</a>->Mode;
<br><a name="454"></a>    
<br><a name="455"></a>    <font color="blue">int </font><a href="parse.html#519">Prev<a href="parse.html#519">ScopeID</a></a> = 0, <a href="parse.html#519">ScopeID</a> = <a style="color:green" href="variable.html#165">VariableScopeBegin</a>(<a href="parse.html#23">Parser</a>, &<a href="parse.html#519">Prev<a href="parse.html#519">ScopeID</a></a>);
<br><a name="456"></a>
<br><a name="457"></a>    <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenOpenBracket)
<br><a name="458"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "'(' expected");
<br><a name="459"></a>                        
<br><a name="460"></a>    <font color="red">if </font>(<a style="color:green" href="parse.html#568">ParseStatement</a>(<a href="parse.html#23">Parser</a>, TRUE) != ParseResultOk)
<br><a name="461"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "statement expected");
<br><a name="462"></a>    
<br><a name="463"></a>    <a style="color:green" href="parse.html#435"><a href="parse.html#23">Parser</a>CopyPos</a>(&PreConditional, <a href="parse.html#23">Parser</a>);
<br><a name="464"></a>    <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, FALSE) == TokenSemicolon)
<br><a name="465"></a>        <a href="parse.html#23">Condition</a> = TRUE;
<br><a name="466"></a>    else
<br><a name="467"></a>        <a href="parse.html#23">Condition</a> = <a style="color:green" href="expression.html#1569">ExpressionParseInt</a>(<a href="parse.html#23">Parser</a>);
<br><a name="468"></a>    
<br><a name="469"></a>    <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenSemicolon)
<br><a name="470"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "';' expected");
<br><a name="471"></a>    
<br><a name="472"></a>    <a style="color:green" href="parse.html#435"><a href="parse.html#23">Parser</a>CopyPos</a>(&PreIncrement, <a href="parse.html#23">Parser</a>);
<br><a name="473"></a>    <a style="color:green" href="parse.html#23">ParseStatementMaybeRun</a>(<a href="parse.html#23">Parser</a>, FALSE, FALSE);
<br><a name="474"></a>    
<br><a name="475"></a>    <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenCloseBracket)
<br><a name="476"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "')' expected");
<br><a name="477"></a>    
<br><a name="478"></a>    <a style="color:green" href="parse.html#435"><a href="parse.html#23">Parser</a>CopyPos</a>(&PreStatement, <a href="parse.html#23">Parser</a>);
<br><a name="479"></a>    <font color="red">if </font>(<a style="color:green" href="parse.html#23">ParseStatementMaybeRun</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#23">Condition</a>, TRUE) != ParseResultOk)
<br><a name="480"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "statement expected");
<br><a name="481"></a>    
<br><a name="482"></a>    <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeContinue && <a href="parse.html#27">OldMode</a> == RunModeRun)
<br><a name="483"></a>        <a href="parse.html#23">Parser</a>->Mode = RunModeRun;
<br><a name="484"></a>        
<br><a name="485"></a>    <a style="color:green" href="parse.html#435"><a href="parse.html#23">Parser</a>CopyPos</a>(&After, <a href="parse.html#23">Parser</a>);
<br><a name="486"></a>        
<br><a name="487"></a>    <font color="red">while </font>(<a href="parse.html#23">Condition</a> && <a href="parse.html#23">Parser</a>->Mode == RunModeRun)
<br><a name="488"></a>    {
<br><a name="489"></a>        <a style="color:green" href="parse.html#435"><a href="parse.html#23">Parser</a>CopyPos</a>(<a href="parse.html#23">Parser</a>, &PreIncrement);
<br><a name="490"></a>        <a style="color:green" href="parse.html#568">ParseStatement</a>(<a href="parse.html#23">Parser</a>, FALSE);
<br><a name="491"></a>                        
<br><a name="492"></a>        <a style="color:green" href="parse.html#435"><a href="parse.html#23">Parser</a>CopyPos</a>(<a href="parse.html#23">Parser</a>, &PreConditional);
<br><a name="493"></a>        <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, FALSE) == TokenSemicolon)
<br><a name="494"></a>            <a href="parse.html#23">Condition</a> = TRUE;
<br><a name="495"></a>        else
<br><a name="496"></a>            <a href="parse.html#23">Condition</a> = <a style="color:green" href="expression.html#1569">ExpressionParseInt</a>(<a href="parse.html#23">Parser</a>);
<br><a name="497"></a>        
<br><a name="498"></a>        <font color="red">if </font>(<a href="parse.html#23">Condition</a>)
<br><a name="499"></a>        {
<br><a name="500"></a>            <a style="color:green" href="parse.html#435"><a href="parse.html#23">Parser</a>CopyPos</a>(<a href="parse.html#23">Parser</a>, &PreStatement);
<br><a name="501"></a>            <a style="color:green" href="parse.html#568">ParseStatement</a>(<a href="parse.html#23">Parser</a>, TRUE);
<br><a name="502"></a>            
<br><a name="503"></a>            <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeContinue)
<br><a name="504"></a>                <a href="parse.html#23">Parser</a>->Mode = RunModeRun;                
<br><a name="505"></a>        }
<br><a name="506"></a>    }
<br><a name="507"></a>    
<br><a name="508"></a>    <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeBreak && <a href="parse.html#27">OldMode</a> == RunModeRun)
<br><a name="509"></a>        <a href="parse.html#23">Parser</a>->Mode = RunModeRun;
<br><a name="510"></a>
<br><a name="511"></a>    <a style="color:green" href="variable.html#206">VariableScopeEnd</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#455">ScopeID</a>, Prev<a href="parse.html#455">ScopeID</a>);
<br><a name="512"></a>
<br><a name="513"></a>    <a style="color:green" href="parse.html#435"><a href="parse.html#23">Parser</a>CopyPos</a>(<a href="parse.html#23">Parser</a>, &After);
<br><a name="514"></a>}
<br><a name="515"></a>
<br><a name="516"></a>/* parse a block of code and <font color="red">return </font>what mode it returned in */
<br><a name="517"></a>enum RunMode ParseBlock(<font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> *<a href="parse.html#23">Parser</a>, <font color="blue">int </font>AbsorbOpenBrace, <font color="blue">int </font><a href="parse.html#23">Condition</a>)
<br><a name="518"></a>{
<br><a name="519"></a>    <font color="blue">int </font><a href="parse.html#455">Prev<a href="parse.html#455">ScopeID</a></a> = 0, <a href="parse.html#455">ScopeID</a> = <a style="color:green" href="variable.html#165">VariableScopeBegin</a>(<a href="parse.html#23">Parser</a>, &<a href="parse.html#455">Prev<a href="parse.html#455">ScopeID</a></a>);
<br><a name="520"></a>
<br><a name="521"></a>    <font color="red">if </font>(<a href="parse.html#517">AbsorbOpenBrace</a> && <a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenLeftBrace)
<br><a name="522"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "'{' expected");
<br><a name="523"></a>
<br><a name="524"></a>    <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeSkip || !Condition)
<br><a name="525"></a>    { 
<br><a name="526"></a>        /* condition failed - skip this block instead */
<br><a name="527"></a>        enum RunMode <a href="parse.html#27">OldMode</a> = <a href="parse.html#23">Parser</a>->Mode;
<br><a name="528"></a>        <a href="parse.html#23">Parser</a>->Mode = RunModeSkip;
<br><a name="529"></a>        <font color="red">while </font>(<a style="color:green" href="parse.html#568">ParseStatement</a>(<a href="parse.html#23">Parser</a>, TRUE) == ParseResultOk)
<br><a name="530"></a>        {}
<br><a name="531"></a>        <a href="parse.html#23">Parser</a>->Mode = <a href="parse.html#27">OldMode</a>;
<br><a name="532"></a>    }
<br><a name="533"></a>    else
<br><a name="534"></a>    { 
<br><a name="535"></a>        /* just run it in its current mode */
<br><a name="536"></a>        <font color="red">while </font>(<a style="color:green" href="parse.html#568">ParseStatement</a>(<a href="parse.html#23">Parser</a>, TRUE) == ParseResultOk)
<br><a name="537"></a>        {}
<br><a name="538"></a>    }
<br><a name="539"></a>    
<br><a name="540"></a>    <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenRightBrace)
<br><a name="541"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "'}' expected");
<br><a name="542"></a>
<br><a name="543"></a>    <a style="color:green" href="variable.html#206">VariableScopeEnd</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#455">ScopeID</a>, Prev<a href="parse.html#455">ScopeID</a>);
<br><a name="544"></a>
<br><a name="545"></a>    <font color="red">return </font><a href="parse.html#23">Parser</a>->Mode;
<br><a name="546"></a>}
<br><a name="547"></a>
<br><a name="548"></a>/* parse a <font color="blue">typedef </font>declaration */
<br><a name="549"></a>void ParseTypedef(<font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> *<a href="parse.html#23">Parser</a>)
<br><a name="550"></a>{
<br><a name="551"></a>    <font color="blue">struct </font><a href="interpreter_header.html#160">Value<a href="parse.html#318">Typ</a>e</a> *<a href="parse.html#318">Typ</a>;
<br><a name="552"></a>    <font color="blue">struct </font><a href="interpreter_header.html#160">ValueType</a> **TypPtr;
<br><a name="553"></a>    <font color="blue">char </font>*TypeName;
<br><a name="554"></a>    <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> Init<a href="interpreter_header.html#217">Value</a>;
<br><a name="555"></a>    
<br><a name="556"></a>    <a style="color:green" href="type.html#526">TypeParse</a>(<a href="parse.html#23">Parser</a>, &Typ, &TypeName, NULL);
<br><a name="557"></a>    
<br><a name="558"></a>    <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeRun)
<br><a name="559"></a>    {
<br><a name="560"></a>        <a href="parse.html#552">TypPtr</a> = &Typ;
<br><a name="561"></a>        <a href="parse.html#554">InitValue</a>.Typ = &Parser->pc->TypeType;
<br><a name="562"></a>        <a href="parse.html#554">InitValue</a>.Val = (union <a href="interpreter_header.html#196">AnyValue</a> *)<a href="parse.html#552">TypPtr</a>;
<br><a name="563"></a>        <a style="color:green" href="variable.html#259">VariableDefine</a>(<a href="parse.html#23">Parser</a>->pc, <a href="parse.html#23">Parser</a>, <a href="parse.html#553">TypeName</a>, &InitValue, NULL, FALSE);
<br><a name="564"></a>    }
<br><a name="565"></a>}
<br><a name="566"></a>
<br><a name="567"></a>/* parse a statement */
<br><a name="568"></a>enum ParseResult <a href="interpreter_header.html#116">ParseState</a>ment(<font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> *<a href="parse.html#23">Parser</a>, <font color="blue">int </font><a href="parse.html#23">CheckTrailingSemicolon</a>)
<br><a name="569"></a>{
<br><a name="570"></a>    <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *C<a href="interpreter_header.html#217">Value</a>;
<br><a name="571"></a>    <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *Lexer<a href="interpreter_header.html#217">Value</a>;
<br><a name="572"></a>    <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *Var<a href="interpreter_header.html#217">Value</a>;
<br><a name="573"></a>    <font color="blue">int </font><a href="parse.html#23">Condition</a>;
<br><a name="574"></a>    <font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> PreState;
<br><a name="575"></a>    enum Lex<a href="parse.html#43">Token</a> <a href="parse.html#43">Token</a>;
<br><a name="576"></a>    
<br><a name="577"></a>    /* <font color="red">if </font>we're debugging, check <font color="red">for </font>a breakpo<font color="blue">int </font>*/
<br><a name="578"></a>    <font color="red">if </font>(<a href="parse.html#23">Parser</a>->DebugMode && <a href="parse.html#23">Parser</a>->Mode == RunModeRun)
<br><a name="579"></a>        <a style="color:green" href="debug.html#97">DebugCheckStatement</a>(<a href="parse.html#23">Parser</a>);
<br><a name="580"></a>    
<br><a name="581"></a>    /* take note of where we are and then grab a token to see what statement we have */   
<br><a name="582"></a>    <a style="color:green" href="parse.html#429"><a href="parse.html#23">Parser</a>Copy</a>(&PreState, <a href="parse.html#23">Parser</a>);
<br><a name="583"></a>    <a href="parse.html#43">Token</a> = LexGet<a href="parse.html#43">Token</a>(<a href="parse.html#23">Parser</a>, &LexerValue, TRUE);
<br><a name="584"></a>    
<br><a name="585"></a>    switch (<a href="parse.html#43">Token</a>)
<br><a name="586"></a>    {
<br><a name="587"></a>        case TokenEOF:
<br><a name="588"></a>            <font color="red">return </font>ParseResultEOF;
<br><a name="589"></a>            
<br><a name="590"></a>        case TokenIdentifier:
<br><a name="591"></a>            /* might be a typedef-typed variable declaration or it might be an expression */
<br><a name="592"></a>            <font color="red">if </font>(<a style="color:green" href="variable.html#346">VariableDefined</a>(<a href="parse.html#23">Parser</a>->pc, <a href="parse.html#571">LexerValue</a>->Val->Identifier))
<br><a name="593"></a>            {
<br><a name="594"></a>                <a style="color:green" href="variable.html#360">VariableGet</a>(<a href="parse.html#23">Parser</a>->pc, <a href="parse.html#23">Parser</a>, <a href="parse.html#571">LexerValue</a>->Val->Identifier, &VarValue);
<br><a name="595"></a>                <font color="red">if </font>(<a href="parse.html#572">VarValue</a>->Typ->Base == Type_Type)
<br><a name="596"></a>                {
<br><a name="597"></a>                    *<a href="parse.html#23">Parser</a> = <a href="parse.html#574">PreState</a>;
<br><a name="598"></a>                    <a style="color:green" href="parse.html#314">ParseDeclaration</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#43">Token</a>);
<br><a name="599"></a>                    break;
<br><a name="600"></a>                }
<br><a name="601"></a>            }
<br><a name="602"></a>            else
<br><a name="603"></a>            {
<br><a name="604"></a>                /* it might be a <font color="red">goto </font>label */
<br><a name="605"></a>                enum LexToken NextToken = <a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, FALSE);
<br><a name="606"></a>                <font color="red">if </font>(<a href="parse.html#605">NextToken</a> == TokenColon)
<br><a name="607"></a>                {
<br><a name="608"></a>                    /* declare the identifier as a <font color="red">goto </font>label */
<br><a name="609"></a>                    <a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE);
<br><a name="610"></a>                    <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeGoto && <a href="parse.html#571">LexerValue</a>->Val->Identifier == <a href="parse.html#23">Parser</a>->SearchGotoLabel)
<br><a name="611"></a>                        <a href="parse.html#23">Parser</a>->Mode = RunModeRun;
<br><a name="612"></a>        
<br><a name="613"></a>                    <a href="parse.html#23">CheckTrailingSemicolon</a> = FALSE;
<br><a name="614"></a>                    break;
<br><a name="615"></a>                }
<br><a name="616"></a>#ifdef FEATURE_AUTO_DECLARE_VARIABLES
<br><a name="617"></a>                else /* new_identifier = something */
<br><a name="618"></a>                {    /* try to guess type and declare the variable based on assigned value */
<br><a name="619"></a>                    <font color="red">if </font>(<a href="parse.html#605">NextToken</a> == TokenAssign && !VariableDefinedAndOutOfScope(<a href="parse.html#23">Parser</a>->pc, <a href="parse.html#571">LexerValue</a>->Val->Identifier))
<br><a name="620"></a>                    {
<br><a name="621"></a>                        <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeRun)
<br><a name="622"></a>                        {
<br><a name="623"></a>                            <font color="blue">struct </font><a href="interpreter_header.html#217">Value</a> *C<a href="interpreter_header.html#217">Value</a>;
<br><a name="624"></a>                            char* <a href="parse.html#59">Identifier</a> = <a href="parse.html#571">LexerValue</a>->Val-><a href="parse.html#59">Identifier</a>;
<br><a name="625"></a>
<br><a name="626"></a>                            <a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE);
<br><a name="627"></a>                            <font color="red">if </font>(!ExpressionParse(<a href="parse.html#23">Parser</a>, &CValue))
<br><a name="628"></a>                            {
<br><a name="629"></a>                                <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "expected: expression");
<br><a name="630"></a>                            }
<br><a name="631"></a>                            
<br><a name="632"></a>                            #<font color="red">if </font>0
<br><a name="633"></a>                            PRINT_SOURCE_POS;
<br><a name="634"></a>                            <a style="color:green" href="platform.html#192">PlatformPrintf</a>(<a href="parse.html#23">Parser</a>->pc->CStdOut, "%t %s = %d;\n", <a href="parse.html#176">CValue</a>->Typ, <a href="parse.html#59">Identifier</a>, <a href="parse.html#176">CValue</a>->Val->Integer);
<br><a name="635"></a>                            printf("%d\n", <a style="color:green" href="variable.html#346">VariableDefined</a>(<a href="parse.html#23">Parser</a>->pc, <a href="parse.html#59">Identifier</a>));
<br><a name="636"></a>                            #endif
<br><a name="637"></a>                            <a style="color:green" href="variable.html#259">VariableDefine</a>(<a href="parse.html#23">Parser</a>->pc, <a href="parse.html#23">Parser</a>, <a href="parse.html#59">Identifier</a>, <a href="parse.html#176">CValue</a>, <a href="parse.html#176">CValue</a>->Typ, TRUE);
<br><a name="638"></a>                            break;
<br><a name="639"></a>                        }
<br><a name="640"></a>                    }
<br><a name="641"></a>                }
<br><a name="642"></a>#endif
<br><a name="643"></a>            }
<br><a name="644"></a>            /* else fallthrough to expression */
<br><a name="645"></a>&nbsp&nbsp&nbsp&nbsp    /* no break */
<br><a name="646"></a>            
<br><a name="647"></a>        case TokenAsterisk: 
<br><a name="648"></a>        case TokenAmpersand: 
<br><a name="649"></a>        case TokenIncrement: 
<br><a name="650"></a>        case TokenDecrement: 
<br><a name="651"></a>        case TokenOpenBracket: 
<br><a name="652"></a>            *<a href="parse.html#23">Parser</a> = <a href="parse.html#574">PreState</a>;
<br><a name="653"></a>            <a style="color:green" href="expression.html#1077">ExpressionParse</a>(<a href="parse.html#23">Parser</a>, &CValue);
<br><a name="654"></a>            <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeRun) 
<br><a name="655"></a>                <a style="color:green" href="variable.html#386">VariableStackPop</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#176">CValue</a>);
<br><a name="656"></a>            break;
<br><a name="657"></a>            
<br><a name="658"></a>        case TokenLeftBrace:
<br><a name="659"></a>            <a style="color:green" href="parse.html#517">ParseBlock</a>(<a href="parse.html#23">Parser</a>, FALSE, TRUE);
<br><a name="660"></a>            <a href="parse.html#23">CheckTrailingSemicolon</a> = FALSE;
<br><a name="661"></a>            break;
<br><a name="662"></a>            
<br><a name="663"></a>        case TokenIf:
<br><a name="664"></a>            <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenOpenBracket)
<br><a name="665"></a>                <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "'(' expected");
<br><a name="666"></a>                
<br><a name="667"></a>            <a href="parse.html#23">Condition</a> = <a style="color:green" href="expression.html#1569">ExpressionParseInt</a>(<a href="parse.html#23">Parser</a>);
<br><a name="668"></a>            
<br><a name="669"></a>            <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenCloseBracket)
<br><a name="670"></a>                <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "')' expected");
<br><a name="671"></a>
<br><a name="672"></a>            <font color="red">if </font>(<a style="color:green" href="parse.html#23">ParseStatementMaybeRun</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#23">Condition</a>, TRUE) != ParseResultOk)
<br><a name="673"></a>                <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "statement expected");
<br><a name="674"></a>            
<br><a name="675"></a>            <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, FALSE) == TokenElse)
<br><a name="676"></a>            {
<br><a name="677"></a>                <a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE);
<br><a name="678"></a>                <font color="red">if </font>(<a style="color:green" href="parse.html#23">ParseStatementMaybeRun</a>(<a href="parse.html#23">Parser</a>, !Condition, TRUE) != ParseResultOk)
<br><a name="679"></a>                    <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "statement expected");
<br><a name="680"></a>            }
<br><a name="681"></a>            <a href="parse.html#23">CheckTrailingSemicolon</a> = FALSE;
<br><a name="682"></a>            break;
<br><a name="683"></a>        
<br><a name="684"></a>        case TokenWhile:
<br><a name="685"></a>            {
<br><a name="686"></a>                <font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> <a href="parse.html#448">PreConditional</a>;
<br><a name="687"></a>                enum RunMode <a href="parse.html#718">PreMode</a> = <a href="parse.html#23">Parser</a>->Mode;
<br><a name="688"></a>
<br><a name="689"></a>                <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenOpenBracket)
<br><a name="690"></a>                    <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "'(' expected");
<br><a name="691"></a>                    
<br><a name="692"></a>                <a style="color:green" href="parse.html#435"><a href="parse.html#23">Parser</a>CopyPos</a>(&PreConditional, <a href="parse.html#23">Parser</a>);
<br><a name="693"></a>                do
<br><a name="694"></a>                {
<br><a name="695"></a>                    <a style="color:green" href="parse.html#435"><a href="parse.html#23">Parser</a>CopyPos</a>(<a href="parse.html#23">Parser</a>, &PreConditional);
<br><a name="696"></a>                    <a href="parse.html#23">Condition</a> = <a style="color:green" href="expression.html#1569">ExpressionParseInt</a>(<a href="parse.html#23">Parser</a>);
<br><a name="697"></a>                    <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenCloseBracket)
<br><a name="698"></a>                        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "')' expected");
<br><a name="699"></a>                    
<br><a name="700"></a>                    <font color="red">if </font>(<a style="color:green" href="parse.html#23">ParseStatementMaybeRun</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#23">Condition</a>, TRUE) != ParseResultOk)
<br><a name="701"></a>                        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "statement expected");
<br><a name="702"></a>                    
<br><a name="703"></a>                    <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeContinue)
<br><a name="704"></a>                        <a href="parse.html#23">Parser</a>->Mode = <a href="parse.html#687">PreMode</a>;
<br><a name="705"></a>                    
<br><a name="706"></a>                } <font color="red">while </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeRun && <a href="parse.html#23">Condition</a>);
<br><a name="707"></a>                
<br><a name="708"></a>                <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeBreak)
<br><a name="709"></a>                    <a href="parse.html#23">Parser</a>->Mode = <a href="parse.html#687">PreMode</a>;
<br><a name="710"></a>
<br><a name="711"></a>                <a href="parse.html#23">CheckTrailingSemicolon</a> = FALSE;
<br><a name="712"></a>            }
<br><a name="713"></a>            break;
<br><a name="714"></a>                
<br><a name="715"></a>        case TokenDo:
<br><a name="716"></a>            {
<br><a name="717"></a>                <font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> <a href="parse.html#450">PreStatement</a>;
<br><a name="718"></a>                enum RunMode <a href="parse.html#687">PreMode</a> = <a href="parse.html#23">Parser</a>->Mode;
<br><a name="719"></a>                <a style="color:green" href="parse.html#435"><a href="parse.html#23">Parser</a>CopyPos</a>(&PreStatement, <a href="parse.html#23">Parser</a>);
<br><a name="720"></a>                do
<br><a name="721"></a>                {
<br><a name="722"></a>                    <a style="color:green" href="parse.html#435"><a href="parse.html#23">Parser</a>CopyPos</a>(<a href="parse.html#23">Parser</a>, &PreStatement);
<br><a name="723"></a>                    <font color="red">if </font>(<a style="color:green" href="parse.html#568">ParseStatement</a>(<a href="parse.html#23">Parser</a>, TRUE) != ParseResultOk)
<br><a name="724"></a>                        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "statement expected");
<br><a name="725"></a>                
<br><a name="726"></a>                    <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeContinue)
<br><a name="727"></a>                        <a href="parse.html#23">Parser</a>->Mode = <a href="parse.html#687">PreMode</a>;
<br><a name="728"></a>
<br><a name="729"></a>                    <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenWhile)
<br><a name="730"></a>                        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "'while' expected");
<br><a name="731"></a>                    
<br><a name="732"></a>                    <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenOpenBracket)
<br><a name="733"></a>                        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "'(' expected");
<br><a name="734"></a>                        
<br><a name="735"></a>                    <a href="parse.html#23">Condition</a> = <a style="color:green" href="expression.html#1569">ExpressionParseInt</a>(<a href="parse.html#23">Parser</a>);
<br><a name="736"></a>                    <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenCloseBracket)
<br><a name="737"></a>                        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "')' expected");
<br><a name="738"></a>                    
<br><a name="739"></a>                } <font color="red">while </font>(<a href="parse.html#23">Condition</a> && <a href="parse.html#23">Parser</a>->Mode == RunModeRun);           
<br><a name="740"></a>                
<br><a name="741"></a>                <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeBreak)
<br><a name="742"></a>                    <a href="parse.html#23">Parser</a>->Mode = <a href="parse.html#687">PreMode</a>;
<br><a name="743"></a>            }
<br><a name="744"></a>            break;
<br><a name="745"></a>                
<br><a name="746"></a>        case TokenFor:
<br><a name="747"></a>            <a style="color:green" href="parse.html#445">ParseFor</a>(<a href="parse.html#23">Parser</a>);
<br><a name="748"></a>            <a href="parse.html#23">CheckTrailingSemicolon</a> = FALSE;
<br><a name="749"></a>            break;
<br><a name="750"></a>
<br><a name="751"></a>        case TokenSemicolon: 
<br><a name="752"></a>            <a href="parse.html#23">CheckTrailingSemicolon</a> = FALSE; 
<br><a name="753"></a>            break;
<br><a name="754"></a>
<br><a name="755"></a>        case TokenIntType:
<br><a name="756"></a>        case TokenShortType:
<br><a name="757"></a>        case TokenCharType:
<br><a name="758"></a>        case TokenLongType:
<br><a name="759"></a>        case TokenFloatType:
<br><a name="760"></a>        case TokenDoubleType:
<br><a name="761"></a>        case TokenVoidType:
<br><a name="762"></a>        case TokenStructType:
<br><a name="763"></a>        case TokenUnionType:
<br><a name="764"></a>        case TokenEnumType:
<br><a name="765"></a>        case TokenSignedType:
<br><a name="766"></a>        case TokenUnsignedType:
<br><a name="767"></a>        case TokenStaticType:
<br><a name="768"></a>        case TokenAutoType:
<br><a name="769"></a>        case TokenRegisterType:
<br><a name="770"></a>        case TokenExternType:
<br><a name="771"></a>            *<a href="parse.html#23">Parser</a> = <a href="parse.html#574">PreState</a>;
<br><a name="772"></a>            <a href="parse.html#23">CheckTrailingSemicolon</a> = <a style="color:green" href="parse.html#314">ParseDeclaration</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#43">Token</a>);
<br><a name="773"></a>            break;
<br><a name="774"></a>        
<br><a name="775"></a>        case TokenHashDefine:
<br><a name="776"></a>            <a style="color:green" href="parse.html#366">ParseMacroDefinition</a>(<a href="parse.html#23">Parser</a>);
<br><a name="777"></a>            <a href="parse.html#23">CheckTrailingSemicolon</a> = FALSE;
<br><a name="778"></a>            break;
<br><a name="779"></a>            
<br><a name="780"></a>#ifndef NO_HASH_INCLUDE
<br><a name="781"></a>        case TokenHashInclude:
<br><a name="782"></a>            <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, &LexerValue, TRUE) != TokenStringConstant)
<br><a name="783"></a>                <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "\"filename.h\" expected");
<br><a name="784"></a>            
<br><a name="785"></a>            <a style="color:green" href="include.html#68">IncludeFile</a>(<a href="parse.html#23">Parser</a>->pc, (<font color="blue">char </font>*)<a href="parse.html#571">LexerValue</a>->Val->Pointer);
<br><a name="786"></a>            <a href="parse.html#23">CheckTrailingSemicolon</a> = FALSE;
<br><a name="787"></a>            break;
<br><a name="788"></a>#endif
<br><a name="789"></a>
<br><a name="790"></a>        case TokenSwitch:
<br><a name="791"></a>            <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenOpenBracket)
<br><a name="792"></a>                <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "'(' expected");
<br><a name="793"></a>                
<br><a name="794"></a>            <a href="parse.html#23">Condition</a> = <a style="color:green" href="expression.html#1569">ExpressionParseInt</a>(<a href="parse.html#23">Parser</a>);
<br><a name="795"></a>            
<br><a name="796"></a>            <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenCloseBracket)
<br><a name="797"></a>                <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "')' expected");
<br><a name="798"></a>            
<br><a name="799"></a>            <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, FALSE) != TokenLeftBrace)
<br><a name="800"></a>                <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "'{' expected");
<br><a name="801"></a>            
<br><a name="802"></a>            { 
<br><a name="803"></a>                /* new block so we can store parser state */
<br><a name="804"></a>                enum RunMode <a href="parse.html#27">OldMode</a> = <a href="parse.html#23">Parser</a>->Mode;
<br><a name="805"></a>                <font color="blue">int </font>OldSearchLabel = <a href="parse.html#23">Parser</a>->SearchLabel;
<br><a name="806"></a>                <a href="parse.html#23">Parser</a>->Mode = RunModeCaseSearch;
<br><a name="807"></a>                <a href="parse.html#23">Parser</a>->SearchLabel = <a href="parse.html#23">Condition</a>;
<br><a name="808"></a>                
<br><a name="809"></a>                <a style="color:green" href="parse.html#517">ParseBlock</a>(<a href="parse.html#23">Parser</a>, TRUE, (<a href="parse.html#27">OldMode</a> != RunModeSkip) && (<a href="parse.html#27">OldMode</a> != RunModeReturn));
<br><a name="810"></a>                
<br><a name="811"></a>                <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode != RunModeReturn)
<br><a name="812"></a>                    <a href="parse.html#23">Parser</a>->Mode = <a href="parse.html#27">OldMode</a>;
<br><a name="813"></a>
<br><a name="814"></a>                <a href="parse.html#23">Parser</a>->SearchLabel = <a href="parse.html#805">OldSearchLabel</a>;
<br><a name="815"></a>            }
<br><a name="816"></a>
<br><a name="817"></a>            <a href="parse.html#23">CheckTrailingSemicolon</a> = FALSE;
<br><a name="818"></a>            break;
<br><a name="819"></a>
<br><a name="820"></a>        case TokenCase:
<br><a name="821"></a>            <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeCaseSearch)
<br><a name="822"></a>            {
<br><a name="823"></a>                <a href="parse.html#23">Parser</a>->Mode = RunModeRun;
<br><a name="824"></a>                <a href="parse.html#23">Condition</a> = <a style="color:green" href="expression.html#1569">ExpressionParseInt</a>(<a href="parse.html#23">Parser</a>);
<br><a name="825"></a>                <a href="parse.html#23">Parser</a>->Mode = RunModeCaseSearch;
<br><a name="826"></a>            }
<br><a name="827"></a>            else
<br><a name="828"></a>                <a href="parse.html#23">Condition</a> = <a style="color:green" href="expression.html#1569">ExpressionParseInt</a>(<a href="parse.html#23">Parser</a>);
<br><a name="829"></a>                
<br><a name="830"></a>            <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenColon)
<br><a name="831"></a>                <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "':' expected");
<br><a name="832"></a>            
<br><a name="833"></a>            <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeCaseSearch && <a href="parse.html#23">Condition</a> == <a href="parse.html#23">Parser</a>->SearchLabel)
<br><a name="834"></a>                <a href="parse.html#23">Parser</a>->Mode = RunModeRun;
<br><a name="835"></a>
<br><a name="836"></a>            <a href="parse.html#23">CheckTrailingSemicolon</a> = FALSE;
<br><a name="837"></a>            break;
<br><a name="838"></a>            
<br><a name="839"></a>        case TokenDefault:
<br><a name="840"></a>            <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenColon)
<br><a name="841"></a>                <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "':' expected");
<br><a name="842"></a>            
<br><a name="843"></a>            <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeCaseSearch)
<br><a name="844"></a>                <a href="parse.html#23">Parser</a>->Mode = RunModeRun;
<br><a name="845"></a>                
<br><a name="846"></a>            <a href="parse.html#23">CheckTrailingSemicolon</a> = FALSE;
<br><a name="847"></a>            break;
<br><a name="848"></a>
<br><a name="849"></a>        case TokenBreak:
<br><a name="850"></a>            <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeRun)
<br><a name="851"></a>                <a href="parse.html#23">Parser</a>->Mode = RunModeBreak;
<br><a name="852"></a>            break;
<br><a name="853"></a>            
<br><a name="854"></a>        case TokenContinue:
<br><a name="855"></a>            <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeRun)
<br><a name="856"></a>                <a href="parse.html#23">Parser</a>->Mode = RunModeContinue;
<br><a name="857"></a>            break;
<br><a name="858"></a>            
<br><a name="859"></a>        case TokenReturn:
<br><a name="860"></a>            <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeRun)
<br><a name="861"></a>            {
<br><a name="862"></a>                <font color="red">if </font>(!<a href="parse.html#23">Parser</a>->pc->TopStackFrame || <a href="parse.html#23">Parser</a>->pc->TopStackFrame->ReturnValue->Typ->Base != TypeVoid)
<br><a name="863"></a>                {
<br><a name="864"></a>                    <font color="red">if </font>(!ExpressionParse(<a href="parse.html#23">Parser</a>, &CValue))
<br><a name="865"></a>                        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "value required in return");
<br><a name="866"></a>                    
<br><a name="867"></a>                    <font color="red">if </font>(!Parser->pc->TopStackFrame) /* <font color="red">return </font>from top-level program? */
<br><a name="868"></a>                        <a style="color:green" href="platform_unix.html#135">PlatformExit</a>(<a href="parse.html#23">Parser</a>->pc, <a style="color:green" href="expression.html#164">ExpressionCoerceInteger</a>(<a href="parse.html#176">CValue</a>));
<br><a name="869"></a>                    else
<br><a name="870"></a>                        <a style="color:green" href="expression.html#391">ExpressionAssign</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#23">Parser</a>->pc->TopStackFrame->ReturnValue, <a href="parse.html#176">CValue</a>, TRUE, NULL, 0, FALSE);
<br><a name="871"></a>
<br><a name="872"></a>                    <a style="color:green" href="variable.html#386">VariableStackPop</a>(<a href="parse.html#23">Parser</a>, <a href="parse.html#176">CValue</a>);
<br><a name="873"></a>                }
<br><a name="874"></a>                else
<br><a name="875"></a>                {
<br><a name="876"></a>                    <font color="red">if </font>(<a style="color:green" href="expression.html#1077">ExpressionParse</a>(<a href="parse.html#23">Parser</a>, &CValue))
<br><a name="877"></a>                        <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "value in <font color="red">return </font>from a void function");                    
<br><a name="878"></a>                }
<br><a name="879"></a>                
<br><a name="880"></a>                <a href="parse.html#23">Parser</a>->Mode = RunModeReturn;
<br><a name="881"></a>            }
<br><a name="882"></a>            else
<br><a name="883"></a>                <a style="color:green" href="expression.html#1077">ExpressionParse</a>(<a href="parse.html#23">Parser</a>, &CValue);
<br><a name="884"></a>            break;
<br><a name="885"></a>
<br><a name="886"></a>        case TokenTypedef:
<br><a name="887"></a>            <a style="color:green" href="parse.html#549">ParseTypedef</a>(<a href="parse.html#23">Parser</a>);
<br><a name="888"></a>            break;
<br><a name="889"></a>            
<br><a name="890"></a>        case TokenGoto:
<br><a name="891"></a>            <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, &LexerValue, TRUE) != TokenIdentifier)
<br><a name="892"></a>                <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "identifier expected");
<br><a name="893"></a>            
<br><a name="894"></a>            <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeRun)
<br><a name="895"></a>            { 
<br><a name="896"></a>                /* start scanning <font color="red">for </font>the <font color="red">goto </font>label */
<br><a name="897"></a>                <a href="parse.html#23">Parser</a>->SearchGotoLabel = <a href="parse.html#571">LexerValue</a>->Val->Identifier;
<br><a name="898"></a>                <a href="parse.html#23">Parser</a>->Mode = RunModeGoto;
<br><a name="899"></a>            }
<br><a name="900"></a>            break;
<br><a name="901"></a>                
<br><a name="902"></a>        case TokenDelete:
<br><a name="903"></a>        {
<br><a name="904"></a>            /* try it as a function or variable name to delete */
<br><a name="905"></a>            <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, &LexerValue, TRUE) != TokenIdentifier)
<br><a name="906"></a>                <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "identifier expected");
<br><a name="907"></a>                
<br><a name="908"></a>            <font color="red">if </font>(<a href="parse.html#23">Parser</a>->Mode == RunModeRun)
<br><a name="909"></a>            { 
<br><a name="910"></a>                /* delete this variable or function */
<br><a name="911"></a>                <a href="parse.html#176">CValue</a> = <a style="color:green" href="table.html#101">TableDelete</a>(<a href="parse.html#23">Parser</a>->pc, &<a href="parse.html#23">Parser</a>->pc->GlobalTable, <a href="parse.html#571">LexerValue</a>->Val->Identifier);
<br><a name="912"></a>
<br><a name="913"></a>                <font color="red">if </font>(<a href="parse.html#176">CValue</a> == NULL)
<br><a name="914"></a>                    <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "'%s' is not defined", <a href="parse.html#571">LexerValue</a>->Val->Identifier);
<br><a name="915"></a>                
<br><a name="916"></a>                <a style="color:green" href="variable.html#19">VariableFree</a>(<a href="parse.html#23">Parser</a>->pc, <a href="parse.html#176">CValue</a>);
<br><a name="917"></a>            }
<br><a name="918"></a>            break;
<br><a name="919"></a>        }
<br><a name="920"></a>        
<br><a name="921"></a>        default:
<br><a name="922"></a>            *<a href="parse.html#23">Parser</a> = <a href="parse.html#574">PreState</a>;
<br><a name="923"></a>            <font color="red">return </font>ParseResultError;
<br><a name="924"></a>    }
<br><a name="925"></a>    
<br><a name="926"></a>    <font color="red">if </font>(<a href="parse.html#23">CheckTrailingSemicolon</a>)
<br><a name="927"></a>    {
<br><a name="928"></a>        <font color="red">if </font>(<a style="color:green" href="lex.html#883">LexGetToken</a>(<a href="parse.html#23">Parser</a>, NULL, TRUE) != TokenSemicolon)
<br><a name="929"></a>            <a style="color:green" href="platform.html#134">ProgramFail</a>(<a href="parse.html#23">Parser</a>, "';' expected");
<br><a name="930"></a>    }
<br><a name="931"></a>    
<br><a name="932"></a>    <font color="red">return </font>ParseResultOk;
<br><a name="933"></a>}
<br><a name="934"></a>
<br><a name="935"></a>/* quick scan a source file <font color="red">for </font>definitions */
<br><a name="936"></a>void <a href="interpreter_header.html#61">Picoc</a>Parse(<a href="interpreter_header.html#61">Picoc</a> *<a href="parse.html#7">pc</a>, const <font color="blue">char </font>*FileName, const <font color="blue">char </font>*Source, <font color="blue">int </font>SourceLen, <font color="blue">int </font>RunIt, <font color="blue">int </font>CleanupNow, <font color="blue">int </font>CleanupSource, <font color="blue">int </font>EnableDebugger)
<br><a name="937"></a>{
<br><a name="938"></a>    <font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> <a href="parse.html#23">Parser</a>;
<br><a name="939"></a>    enum ParseResult <a href="parse.html#981">Ok</a>;
<br><a name="940"></a>    <font color="blue">struct </font><a href="interpreter_header.html#331">CleanupTokenNode</a> *NewCleanupNode;
<br><a name="941"></a>    <font color="blue">char </font>*Reg<a href="parse.html#936">FileName</a> = <a style="color:green" href="table.html#166">TableStrRegister</a>(<a href="parse.html#7">pc</a>, <a href="parse.html#936">FileName</a>);
<br><a name="942"></a>    
<br><a name="943"></a>    void *Tokens = <a style="color:green" href="lex.html#593">LexAnalyse</a>(<a href="parse.html#7">pc</a>, <a href="parse.html#941">RegFileName</a>, <a href="parse.html#936">Source</a>, <a href="parse.html#936">Source</a>Len, NULL);
<br><a name="944"></a>    
<br><a name="945"></a>    /* allocate a cleanup node so we can clean up the tokens later */
<br><a name="946"></a>    <font color="red">if </font>(!CleanupNow)
<br><a name="947"></a>    {
<br><a name="948"></a>        <a href="parse.html#940">NewCleanupNode</a> = <a style="color:green" href="heap.html#135">HeapAllocMem</a>(<a href="parse.html#7">pc</a>, sizeof(<font color="blue">struct </font><a href="interpreter_header.html#331">CleanupTokenNode</a>));
<br><a name="949"></a>        <font color="red">if </font>(<a href="parse.html#940">NewCleanupNode</a> == NULL)
<br><a name="950"></a>            <a style="color:green" href="platform.html#147">ProgramFailNoParser</a>(<a href="parse.html#7">pc</a>, "out of memory");
<br><a name="951"></a>        
<br><a name="952"></a>        <a href="parse.html#940">NewCleanupNode</a>-><a href="parse.html#943">Tokens</a> = <a href="parse.html#943">Tokens</a>;
<br><a name="953"></a>        <font color="red">if </font>(<a href="parse.html#936">CleanupSource</a>)
<br><a name="954"></a>            <a href="parse.html#940">NewCleanupNode</a>-><a href="parse.html#936">Source</a>Text = <a href="parse.html#936">Source</a>;
<br><a name="955"></a>        else
<br><a name="956"></a>            <a href="parse.html#940">NewCleanupNode</a>->SourceText = NULL;
<br><a name="957"></a>            
<br><a name="958"></a>        <a href="parse.html#940">NewCleanupNode</a>->Next = <a href="parse.html#7">pc</a>->CleanupTokenList;
<br><a name="959"></a>        <a href="parse.html#7">pc</a>->CleanupTokenList = <a href="parse.html#940">NewCleanupNode</a>;
<br><a name="960"></a>    }
<br><a name="961"></a>    
<br><a name="962"></a>    /* do the parsing */
<br><a name="963"></a>    <a style="color:green" href="lex.html#610">LexInitParser</a>(&Parser, <a href="parse.html#7">pc</a>, <a href="parse.html#936">Source</a>, <a href="parse.html#943">Tokens</a>, <a href="parse.html#941">RegFileName</a>, <a href="parse.html#936">RunIt</a>, <a href="parse.html#936">EnableDebugger</a>);
<br><a name="964"></a>
<br><a name="965"></a>    do {
<br><a name="966"></a>        <a href="parse.html#939">Ok</a> = <a style="color:green" href="parse.html#568">ParseStatement</a>(&Parser, TRUE);
<br><a name="967"></a>    } <font color="red">while </font>(<a href="parse.html#939">Ok</a> == ParseResult<a href="parse.html#939">Ok</a>);
<br><a name="968"></a>    
<br><a name="969"></a>    <font color="red">if </font>(<a href="parse.html#939">Ok</a> == ParseResultError)
<br><a name="970"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(&Parser, "parse error");
<br><a name="971"></a>    
<br><a name="972"></a>    /* clean up */
<br><a name="973"></a>    <font color="red">if </font>(<a href="parse.html#936">CleanupNow</a>)
<br><a name="974"></a>        <a style="color:green" href="heap.html#226">HeapFreeMem</a>(<a href="parse.html#7">pc</a>, <a href="parse.html#943">Tokens</a>);
<br><a name="975"></a>}
<br><a name="976"></a>
<br><a name="977"></a>/* parse interactively */
<br><a name="978"></a>void <a href="interpreter_header.html#61">Picoc</a>ParseInteractiveNoStartPrompt(<a href="interpreter_header.html#61">Picoc</a> *<a href="parse.html#7">pc</a>, <font color="blue">int </font><a href="parse.html#936">EnableDebugger</a>)
<br><a name="979"></a>{
<br><a name="980"></a>    <font color="blue">struct </font><a href="interpreter_header.html#116">ParseState</a> <a href="parse.html#23">Parser</a>;
<br><a name="981"></a>    enum ParseResult <a href="parse.html#939">Ok</a>;
<br><a name="982"></a>    
<br><a name="983"></a>    <a style="color:green" href="lex.html#610">LexInitParser</a>(&Parser, <a href="parse.html#7">pc</a>, NULL, NULL, <a href="parse.html#7">pc</a>->StrEmpty, TRUE, <a href="parse.html#936">EnableDebugger</a>);
<br><a name="984"></a>    PicocPlatformSetExitPoint(<a href="parse.html#7">pc</a>);
<br><a name="985"></a>    <a style="color:green" href="lex.html#995">LexInteractiveClear</a>(<a href="parse.html#7">pc</a>, &Parser);
<br><a name="986"></a>
<br><a name="987"></a>    do
<br><a name="988"></a>    {
<br><a name="989"></a>        <a style="color:green" href="lex.html#1034">LexInteractiveStatementPrompt</a>(<a href="parse.html#7">pc</a>);
<br><a name="990"></a>        <a href="parse.html#939">Ok</a> = <a style="color:green" href="parse.html#568">ParseStatement</a>(&Parser, TRUE);
<br><a name="991"></a>        <a style="color:green" href="lex.html#1013">LexInteractiveCompleted</a>(<a href="parse.html#7">pc</a>, &Parser);
<br><a name="992"></a>        
<br><a name="993"></a>    } <font color="red">while </font>(<a href="parse.html#939">Ok</a> == ParseResult<a href="parse.html#939">Ok</a>);
<br><a name="994"></a>    
<br><a name="995"></a>    <font color="red">if </font>(<a href="parse.html#939">Ok</a> == ParseResultError)
<br><a name="996"></a>        <a style="color:green" href="platform.html#134">ProgramFail</a>(&Parser, "parse error");
<br><a name="997"></a>    
<br><a name="998"></a>    <a style="color:green" href="platform.html#192">PlatformPrintf</a>(<a href="parse.html#7">pc</a>->CStdOut, "\n");
<br><a name="999"></a>}
<br><a name="1000"></a>
<br><a name="1001"></a>/* parse interactively, showing a startup message */
<br><a name="1002"></a>void <a href="interpreter_header.html#61">Picoc</a>ParseInteractive(<a href="interpreter_header.html#61">Picoc</a> *<a href="parse.html#7">pc</a>)
<br><a name="1003"></a>{
<br><a name="1004"></a>    <a style="color:green" href="platform.html#192">PlatformPrintf</a>(<a href="parse.html#7">pc</a>->CStdOut, INTERACTIVE_PROMPT_START);
<br><a name="1005"></a>    <a style="color:green" href="parse.html#978">PicocParseInteractiveNoStartPrompt</a>(<a href="parse.html#7">pc</a>, TRUE);
<br><a name="1006"></a>}
<br><a name="1007"></a></html>